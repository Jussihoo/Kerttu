<!DOCTYPE html>
<html> 
<body>

<h1><center>Weather Station Kerttu</center></h1>

<script src="node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
<script src="node_modules/chart.js/dist/Chart.bundle.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script> var socket = io("http://localhost:8080"); 
  socket.on('PushData', function (data) {
            console.log("data from socket" + data); // remove this
            ShowMeasuredTemp(JSON.parse(data));
            window.myLine.update();
});
            
</script> 

<script>
  var sampleLength = 72; // init as 6 measurements per hour and 12 hours

function handleTemperatureData(client){
  var tempData = JSON.parse(client.responseText);
  sampleLength = tempData.length;
  if (sampleLength <72){
    sampleLength = 72; 
  } 
  clearGraphData(); // clears the graph data
  for (i=0; i<tempData.length;i++) {
    ShowMeasuredTemp(tempData[i]);
  }
  window.myLine.update();
  
}

function visitorCounter(client){
  console.log("The page has been loaded " + JSON.parse(client.responseText) + " times");
  document.getElementById("visitor").innerHTML = "page has been loaded " + JSON.parse(client.responseText) + " times";
}
  
function communicateWithTheServer(url, data, callback) {
    var client = new XMLHttpRequest(); //
    client.onreadystatechange = function() {
        if (client.readyState == 4 && client.status == 200) {
            callback(client);
        }
        // If status code is not 200, do not handle
        if (client.status != 200) {
            console.log("status " + client.status + " State: " + client.readyState);
            return false;
        }
    };
    client.open("POST", url, true);
    client.withCredentials = false;
    client.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
    client.setRequestHeader('Content-Length', data.length);
    client.send(data);
}

function getTempData(range, buttonStats){
  console.log("get data from Kerttu for " + range + " hours");
  sampleLength = parseInt(range) * 6; // 6 measurements within an hour.
  var url = "http://localhost:8080/getTempData";
  var reqData = {range: range, buttonStats: buttonStats};
  var status = communicateWithTheServer(url,JSON.stringify(reqData), handleTemperatureData);
}

function sendLogdata(logdata){
  console.log("Store log information");
  var url = "http://localhost:8080/sendLog";
  var status = communicateWithTheServer(url,JSON.stringify(logdata), visitorCounter);
}

function clearGraphData(){
  config.data.labels.splice(0, config.data.labels.length); // remove all timestamps from label
  config.data.datasets.forEach(function(dataset, datasetIndex) {
      dataset.data.splice(0, dataset.data.length); // remove all data samples
  });  
}

function ShowMeasuredTemp(inputData) {
   
  var temperature = inputData.temp;
  var options = {weekday: "short", hour: "2-digit", minute: "2-digit"};
  var time   = new Date(inputData.time);
  var timestamp = time.toLocaleString([],options);
  document.getElementById("temp").innerHTML = temperature;
  
  if (config.data.datasets.length > 0) {
      config.data.labels.push(timestamp);   // store the timestamp from node.js server as x-axis label
      $.each(config.data.datasets, function(i, dataset) {
          dataset.data.push(temperature); 
      });
  }
  if (config.data.labels.length > sampleLength ) {  // measurement sample upper boundary exceeded, remove the oldest sample
      config.data.labels.splice(0, 1); // remove the first timestamp from label
      config.data.datasets.forEach(function(dataset, datasetIndex) {
            dataset.data.shift(); // remove the first data sample as well
        });
  }
  if (temperature < 0) { // it's freezing out there
    pointColor = "rgba(58,55,250,1)"; // blue
  }
  else {
    pointColor = "rgba(250,10,10,1)"; // red
  }
  config.data.datasets.forEach(function(dataset, datasetIndex) {
    //dataset.borderColor = "rgba(2,2,1,1)";
    //dataset.backgroundColor = pointColor;
    dataset.pointBorderColor.push(pointColor);
    dataset.pointBackgroundColor.push(pointColor);
    dataset.pointRadius = 0;
  });
}
</script>

<table border="0" width="300">
<tr>
<th style="width:100"></th>
<th style="width:100"></th>
<th style="width:100"></th>
</tr>
<tr><td width="100">
  <button type="button" onclick="getTempData(12,true)">12H</button>
  <div id="B12"></div>
</td><td width="100">
  <button type="button" onclick="getTempData(24,true)">24H</button>
  <div id="B24"></div>
</td><td width="100">
  <button type="button" onclick="getTempData(48,true)">48H</button>
  <div id="B48"></div>
</td></tr>
</table>

<table border="0" width="900" height="400">
<tr>
<th style="width:600"></th>
<th style="width:50"></th>
<th style="width:250"></th>
</tr>
<tr><td>
  <div style="width:100%">
        <canvas id="myChart" width="600" height="400"></canvas>
  </div>
</td><td width="50">
</td><td width="250" background="images/display2.png" style="background-repeat:no-repeat;background-position:center">
  <center> <font size="7"><div id="temp"></div></font></center>
</td></tr>
</table>

<center> <font size="1"><div id="visitor"></div></font></center>
    
<script>
// data for the graph
var pointColor = ""; // init
var config = {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: "Temperature",
            pointBorderColor: [],
            pointBackgroundColor: [],
            pointStyle: "circle",
            pointBorderWidth: 0,
            pointRadius: 0,
            fill: false,
            data: [],
        }]
    },
    options: {
        responsive: true,
        legend: {
            position: 'bottom',
        },
        hover: {
            mode: 'label'
        },
        elements: {
            point: {
                radius: 1
            }
        },
        scales: {
            xAxes: [{
                display: true,
                scaleLabel: {
                    display: true,
                    labelString: 'Time'
                },
                ticks: {
                  maxTicksLimit: 12
                }
            }],
            yAxes: [{
                display: true,
                scaleLabel: {
                    display: true,
                    labelString: 'Â°Celsius'
                }
            }]
        },
        title: {
            display: true,
            text: 'Temperature'
        }
    }
};
window.onload = function() {
    // this is a temporary solution. This service is free to use for 1000 request per day
    // evaluate a better solution or implement own solution for this
    $.get("http://ipinfo.io", function(response) {
      sendLogdata(response);
    }, "jsonp");
    var ctx = document.getElementById("myChart").getContext("2d");
    window.myLine = new Chart(ctx, config);
    getTempData(12,null);// get recorded measurements from the database
};
document.getElementById("temp").innerHTML = "---"; // init
</script>
</body>
</html> 
