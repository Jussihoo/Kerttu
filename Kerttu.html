<!DOCTYPE html>
<html> 
<body>

<h1><center>Weather Station Kerttu</center></h1>

<script src="node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
<script src="node_modules/chart.js/dist/Chart.bundle.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script> var socket = io("http://localhost:8080"); 
  socket.on('PushData', function (data) {
            console.log("data from socket" + data); // remove this
            ShowMeasuredTemp(JSON.parse(data));
            window.myLine.update();
});
            
</script> 

<script>
  var client = new XMLHttpRequest(); //

client.onreadystatechange = function() {
  if (client.readyState == 4 && client.status == 200) {
      var tempData = JSON.parse(client.responseText); 
      for (i=0; i<tempData.length;i++) {
      ShowMeasuredTemp(tempData[i]);
      }
      window.myLine.update();
  }
  // If status code is not 200, do not handle
  if (client.status != 200) {
      console.log("status " + client.status + " State: " + client.readyState);
      return false;
  }
}

function getTempData(){
  console.log("get data from Kerttu");
  var url = "http://localhost:8080/getTempData";
  client.open("GET", url, true);
  client.withCredentials = false;
  client.send();
}

function ShowMeasuredTemp(inputData) { 
  var temperature = inputData.temp;
  var options = {hour: "2-digit", minute: "2-digit"};
  var time   = new Date(inputData.time);
  var timestamp = time.toLocaleString([],options);
  document.getElementById("temp").innerHTML = temperature;
  
  if (config.data.datasets.length > 0) {
      config.data.labels.push(timestamp);   // store the timestamp from noje.js server as x-axis label
      $.each(config.data.datasets, function(i, dataset) {
          dataset.data.push(temperature); 
      });
  }
  if (config.data.labels.length > 144 ) {  // 144 measurement samples exceeded, remove the oldest sample
      config.data.labels.splice(0, 1); // remove the first timestamp from label
      config.data.datasets.forEach(function(dataset, datasetIndex) {
            dataset.data.shift(); // remove the first data sample as well
        });
  }
  if (temperature < 0) { // it's freezing out there
    pointColor = "rgba(58,55,250,1)"; // blue
  }
  else {
    pointColor = "rgba(250,10,10,1)"; // red
  }
  config.data.datasets.forEach(function(dataset, datasetIndex) {
    //dataset.borderColor = "rgba(2,2,1,1)";
    //dataset.backgroundColor = pointColor;
    dataset.pointBorderColor.push(pointColor);
    dataset.pointBackgroundColor.push(pointColor);
    dataset.pointRadius = 0;
  });
}
</script>

<table border="0" width="900" height="400">
<tr>
<th style="width:600"></th>
<th style="width:50"></th>
<th style="width:250"></th>
</tr>
<tr><td>
  <div style="width:100%">
        <canvas id="myChart" width="600" height="400"></canvas>
  </div>
</td><td width="50">
</td><td width="250" background="images/display2.png" style="background-repeat:no-repeat;background-position:center">
  <center> <font size="7"><div id="temp"></div></font></center>
</td></tr>
</table>

<div style="width:40%;">
        <canvas id="myChart" width="500" height="400"></canvas>
    </div>
    
<script>
// data for the graph
var pointColor = ""; // init
var config = {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: "Temperature",
            pointBorderColor: [],
            pointBackgroundColor: [],
            pointStyle: "circle",
            pointBorderWidth: 0,
            pointRadius: 0,
            fill: false,
            data: [],
        }]
    },
    options: {
        responsive: true,
        legend: {
            position: 'bottom',
        },
        hover: {
            mode: 'label'
        },
        elements: {
            point: {
                radius: 1
            }
        },
        scales: {
            xAxes: [{
                display: true,
                scaleLabel: {
                    display: true,
                    labelString: 'Time'
                },
                ticks: {
                  maxTicksLimit: 12
                }
            }],
            yAxes: [{
                display: true,
                scaleLabel: {
                    display: true,
                    labelString: 'Â°Celsius'
                }
            }]
        },
        title: {
            display: true,
            text: 'Temperature'
        }
    }
};
window.onload = function() {
    var ctx = document.getElementById("myChart").getContext("2d");
    window.myLine = new Chart(ctx, config);
    getTempData();// get recorded measurements from the database
};
document.getElementById("temp").innerHTML = "---"; // init
</script>
</body>
</html> 
